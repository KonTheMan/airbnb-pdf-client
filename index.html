<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Airbnb Search & Filter</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background: #f7f7f7;
      color: #222;
      line-height: 1.6;
    }

    .container {
      width: 90%;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .auth-banner {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .auth-banner.signed-in {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }

    .auth-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .auth-info img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid white;
    }

    .auth-text h3 {
      font-size: 14px;
      margin-bottom: 2px;
    }

    .auth-text p {
      font-size: 12px;
      opacity: 0.85;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .export-btn-header {
      padding: 10px 20px;
      background: rgba(255,255,255,0.95);
      color: #11998e;
      border: 2px solid white;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: none;
    }

    .export-btn-header.visible {
      display: block;
    }

    .export-btn-header:hover {
      background: white;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .export-btn-header:disabled {
      background: rgba(255,255,255,0.5);
      cursor: not-allowed;
      transform: none;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 26px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255,255,255,0.3);
      transition: .3s;
      border-radius: 26px;
      border: 2px solid white;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: rgba(255,255,255,0.5);
    }

    input:checked + .slider:before {
      transform: translateX(24px);
    }

    .search-section {
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .search-section h1 {
      text-align: center;
      margin-bottom: 25px;
      font-size: 28px;
      color: #222;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 5px;
      font-size: 14px;
      color: #222;
    }

    input[type="text"],
    input[type="date"],
    input[type="number"] {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.2s;
    }

    input[type="text"]:focus,
    input[type="date"]:focus,
    input[type="number"]:focus {
      outline: none;
      border-color: #FF385C;
    }

    .amenities-section {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin: 20px 0;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 8px;
    }

    .amenity-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .amenity-checkbox input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: #FF385C;
    }

    .amenity-checkbox label {
      margin: 0;
      cursor: pointer;
      font-weight: 500;
    }

    .submit-btn {
      width: 100%;
      padding: 15px;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .submit-btn:hover {
      background-color: #0056b3;
    }

    .submit-btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .results-section {
      display: none;
    }

    .results-section.active {
      display: block;
    }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .results-count {
      font-size: 20px;
      font-weight: 600;
    }

    .new-search-btn {
      padding: 10px 20px;
      background: #fff;
      color: #FF385C;
      border: 2px solid #FF385C;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .new-search-btn:hover {
      background: #FF385C;
      color: white;
    }

    .listings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 24px;
    }

    .listing-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
    }

    .listing-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }

    .listing-image {
      width: 100%;
      height: 220px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 48px;
      position: relative;
    }

    .listing-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .compatibility-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }

    .listing-content {
      padding: 20px;
    }

    .listing-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .listing-location {
      color: #717171;
      font-size: 14px;
      margin-bottom: 12px;
    }

    .amenities-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 12px;
      min-height: 30px;
    }

    .amenity-tag {
      background: #FFF4F4;
      color: #FF385C;
      padding: 4px 10px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 500;
    }

    .listing-price {
      font-size: 16px;
      font-weight: 600;
      color: #222;
    }

    .listing-price span {
      font-weight: 400;
      font-size: 14px;
      color: #717171;
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
      font-size: 18px;
      color: #717171;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .loading::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }

    .error-message {
      background: #FFF4F4;
      color: #C13515;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      margin: 20px 0;
    }

    .no-results {
      text-align: center;
      padding: 60px 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .no-results h3 {
      font-size: 24px;
      margin-bottom: 10px;
      color: #222;
    }

    .no-results p {
      color: #717171;
      font-size: 16px;
    }

    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .amenities-section {
        flex-direction: column;
        gap: 12px;
      }

      .results-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }

      .auth-banner {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }

      .header-actions {
        flex-direction: column;
        width: 100%;
      }

      .export-btn-header {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Auth Banner -->
    <div class="auth-banner" id="authBanner">
      <div class="auth-info">
        <div id="googleSignInButton"></div>
        <div class="auth-text" id="userInfo" style="display: none;">
          <img id="userPhoto" src="" alt="User">
          <div>
            <h3 id="userName"></h3>
            <p>Ready to export to Google Drive</p>
          </div>
        </div>
      </div>
      <div class="header-actions">
        <button class="export-btn-header" id="exportBtnHeader" onclick="exportToGoogleDrive()">📄 Export to Google Drive</button>
        <label class="switch" id="signoutSwitch" style="display: none;">
          <input type="checkbox" id="signoutToggle" checked onchange="handleSignOutToggle()">
          <span class="slider"></span>
        </label>
      </div>
    </div>

    <div class="search-section" id="searchSection">
      <h1>Find Your Perfect Airbnb</h1>
      <form id="airbnbForm">
        <div class="form-grid">
          <div>
            <label>Location</label>
            <input type="text" name="location" placeholder="Where are you going?" required>
          </div>
          <div>
            <label>Check-in Date</label>
            <input type="date" name="checkin" required>
          </div>
          <div>
            <label>Check-out Date</label>
            <input type="date" name="checkout" required>
          </div>
          <div>
            <label>Guests</label>
            <input type="number" name="guests" min="1" value="1" required>
          </div>
        </div>

        <div class="amenities-section">
          <strong style="width: 100%; margin-bottom: -10px;">Amenities:</strong>
          <div class="amenity-checkbox">
            <input type="checkbox" id="pool" name="pool">
            <label for="pool">Pool</label>
          </div>
          <div class="amenity-checkbox">
            <input type="checkbox" id="pickleball" name="pickleball">
            <label for="pickleball">Pickleball</label>
          </div>
          <div class="amenity-checkbox">
            <input type="checkbox" id="gym" name="gym">
            <label for="gym">Private Gym</label>
          </div>
        </div>

        <button type="submit" class="submit-btn">Search Listings</button>
      </form>
    </div>

    <div class="results-section" id="resultsSection">
      <div class="results-header">
        <div class="results-count" id="resultsCount"></div>
        <button class="new-search-btn" onclick="newSearch()">New Search</button>
      </div>
      <div id="listingsContainer"></div>
    </div>
  </div>

  <script>
    const GOOGLE_CLIENT_ID = '529448847987-pfu9d0dv5i4o2h96ak7j4si19vdvou4i.apps.googleusercontent.com';
    
    let googleUser = null;
    let accessToken = null;

    function initializeGoogleSignIn() {
      google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: handleCredentialResponse,
        auto_select: false,
      });

      google.accounts.id.renderButton(
        document.getElementById('googleSignInButton'),
        { 
          theme: 'filled_blue', 
          size: 'large',
          text: 'signin_with',
          shape: 'rectangular'
        }
      );

      window.tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope: 'https://www.googleapis.com/auth/drive.file',
        callback: (response) => {
          if (response.access_token) {
            accessToken = response.access_token;
            console.log('Got access token for Drive');
          }
        },
      });
    }

    function handleCredentialResponse(response) {
      const userInfo = parseJwt(response.credential);
      
      googleUser = {
        name: userInfo.name,
        email: userInfo.email,
        picture: userInfo.picture
      };

      updateAuthUI(true);
      window.tokenClient.requestAccessToken();
    }

    function parseJwt(token) {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    }

    function updateAuthUI(signedIn) {
      const authBanner = document.getElementById('authBanner');
      const signInButton = document.getElementById('googleSignInButton');
      const userInfo = document.getElementById('userInfo');
      const signoutSwitch = document.getElementById('signoutSwitch');
      const exportBtn = document.getElementById('exportBtnHeader');

      if (signedIn && googleUser) {
        authBanner.classList.add('signed-in');
        signInButton.style.display = 'none';
        userInfo.style.display = 'flex';
        signoutSwitch.style.display = 'block';
        
        document.getElementById('userName').textContent = googleUser.name;
        document.getElementById('userPhoto').src = googleUser.picture;
        document.getElementById('signoutToggle').checked = true;
        
        exportBtn.disabled = false;
      } else {
        authBanner.classList.remove('signed-in');
        signInButton.style.display = 'block';
        userInfo.style.display = 'none';
        signoutSwitch.style.display = 'none';
        exportBtn.disabled = true;
        exportBtn.classList.remove('visible');
      }
    }

    function handleSignOutToggle() {
      const toggle = document.getElementById('signoutToggle');
      if (!toggle.checked) {
        google.accounts.id.disableAutoSelect();
        googleUser = null;
        accessToken = null;
        updateAuthUI(false);
      }
    }

    window.onload = () => {
      initializeGoogleSignIn();
      updateAuthUI(false);
    };

    const form = document.getElementById('airbnbForm');
    const submitButton = form.querySelector('.submit-btn');
    const checkin = form.checkin;
    const checkout = form.checkout;
    const searchSection = document.getElementById('searchSection');
    const resultsSection = document.getElementById('resultsSection');
    const listingsContainer = document.getElementById('listingsContainer');
    const resultsCount = document.getElementById('resultsCount');
    const exportBtn = document.getElementById('exportBtnHeader');

    let currentListings = [];

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    const todayStr = `${yyyy}-${mm}-${dd}`;

    checkin.min = todayStr;
    checkin.value = '';
    checkout.min = todayStr;
    checkout.value = '';

    checkin.addEventListener('change', () => {
      const selectedDate = new Date(checkin.value);
      if (selectedDate < today) {
        checkin.value = todayStr;
        alert('Check-in date cannot be in the past.');
      }
      
      if (checkin.value) {
        checkout.min = checkin.value;
        if (checkout.value && checkout.value < checkin.value) {
          checkout.value = checkin.value;
        }
      }
    });

    checkout.addEventListener('change', () => {
      if (checkin.value && checkout.value < checkin.value) {
        checkout.value = checkin.value;
        alert('Check-out date cannot be before check-in date.');
      }
      
      const selectedDate = new Date(checkout.value);
      if (selectedDate < today) {
        checkout.value = todayStr;
        alert('Check-out date cannot be in the past.');
      }
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (checkin.value < todayStr) {
        alert('Check-in date cannot be in the past.');
        return;
      }
      if (checkout.value < checkin.value) {
        alert('Check-out date cannot be before check-in.');
        return;
      }
      if (checkout.value < todayStr) {
        alert('Check-out date cannot be in the past.');
        return;
      }

      const data = {
        location: form.location.value,
        checkin: form.checkin.value,
        checkout: form.checkout.value,
        guests: Number(form.guests.value),
        pool: form.pool.checked,
        pickleball: form.pickleball.checked,
        privateGym: form.gym.checked,
        gym: form.gym.checked
      };

      searchSection.style.display = 'none';
      resultsSection.classList.add('active');
      listingsContainer.innerHTML = '<div class="loading">Searching for listings</div>';
      submitButton.disabled = true;

      try {
        const response = await fetch('https://n8n-hqbt.onrender.com/webhook/airbnb-search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          throw new Error(`Server error: ${response.status} ${response.statusText}`);
        }

        const result = await response.json();
        console.log('Webhook response:', result);

        let listings = [];

        if (Array.isArray(result)) {
          if (result.length > 0 && result[0].json) {
            listings = result.flatMap(item => {
              if (Array.isArray(item.json)) {
                return item.json;
              }
              return [item.json];
            });
          } else {
            listings = result;
          }
        } else if (result.json) {
          listings = Array.isArray(result.json) ? result.json : [result.json];
        } else {
          listings = [result];
        }

        console.log('Processed listings:', listings);
        console.log('Number of listings:', listings.length);
        
        currentListings = listings;
        listings.sort((a, b) => (b.compatibilityScore || 0) - (a.compatibilityScore || 0));
        
        displayListings(listings);
        exportBtn.classList.add('visible');

      } catch (error) {
        console.error('Error:', error);
        listingsContainer.innerHTML = `
          <div class="error-message">
            <strong>Error loading listings</strong><br>
            ${error.message}<br>
            Please try again.
          </div>
        `;
      } finally {
        submitButton.disabled = false;
      }
    });

    function displayListings(listings) {
      if (listings.length === 0 || (listings.length === 1 && listings[0].message)) {
        listingsContainer.innerHTML = `
          <div class="no-results">
            <h3>No listings found</h3>
            <p>Try adjusting your search criteria or amenity filters</p>
          </div>
        `;
        resultsCount.textContent = '0 listings found';
        return;
      }

      resultsCount.textContent = `${listings.length} listing${listings.length !== 1 ? 's' : ''} found`;

      const listingsHTML = listings.map(listing => {
        const amenitiesHTML = listing.matchedAmenities && listing.matchedAmenities.length > 0
          ? listing.matchedAmenities.map(amenity => 
              `<span class="amenity-tag">${amenity}</span>`
            ).join('')
          : '';

        const score = listing.compatibilityScore || 0;
        const name = listing.title || 'Luxury Property';
        const location = listing.locationSubtitle || listing.location || 'Premium Location';
        
        let pricePerNight = null;
        if (listing.price && listing.price.breakDown && listing.price.breakDown.basePrice) {
          const basePrice = listing.price.breakDown.basePrice.description;
          const match = basePrice.match(/\$([0-9,.]+)/);
          if (match) {
            pricePerNight = match[1];
          }
        }
        
        const imageUrl = listing.thumbnail || (listing.images && listing.images[0] ? listing.images[0].imageUrl : null);

        return `
          <div class="listing-card" onclick="window.open('${listing.url}', '_blank')">
            <div class="listing-image" style="${imageUrl ? `background-image: url('${imageUrl}'); background-size: cover; background-position: center;` : ''}">
              ${!imageUrl ? '🏠' : ''}
              ${score > 0 ? `<span class="compatibility-badge">✓ ${score} Match${score > 1 ? 'es' : ''}</span>` : ''}
            </div>
            <div class="listing-content">
              <div class="listing-title">${name}</div>
              <div class="listing-location">${location}</div>
              ${amenitiesHTML ? `<div class="amenities-tags">${amenitiesHTML}</div>` : '<div class="amenities-tags"></div>'}
              ${pricePerNight ? `<div class="listing-price">${pricePerNight} <span>/ night</span></div>` : ''}
            </div>
          </div>
        `;
      }).join('');

      listingsContainer.innerHTML = `<div class="listings-grid">${listingsHTML}</div>`;
    }

    function newSearch() {
      resultsSection.classList.remove('active');
      searchSection.style.display = 'block';
      currentListings = [];
      exportBtn.classList.remove('visible');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function exportToGoogleDrive() {
      if (!accessToken) {
        alert('Please sign in with Google first!');
        window.tokenClient.requestAccessToken();
        return;
      }

      if (currentListings.length === 0) {
        alert('No listings to export');
        return;
      }

      exportBtn.disabled = true;
      exportBtn.textContent = '📄 Exporting...';

      try {
        const response = await fetch('https://n8n-hqbt.onrender.com/webhook/export-to-drive', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            listings: currentListings,
            searchCriteria: {
              location: form.location.value,
              checkin: form.checkin.value,
              checkout: form.checkout.value,
              guests: form.guests.value
            },
            accessToken: accessToken
          })
        });

        if (!response.ok) {
          throw new Error('Export failed');
        }

        const result = await response.json();
        alert('Successfully exported to your Google Drive!');
        
        if (result.fileUrl) {
          window.open(result.fileUrl, '_blank');
        }

      } catch (error) {
        console.error('Export error:', error);
        alert('Failed to export to Google Drive. Please try again.');
      } finally {
        exportBtn.disabled = false;
        exportBtn.textContent = '📄 Export to Google Drive';
      }
    }
  </script>
</body>
</html>
